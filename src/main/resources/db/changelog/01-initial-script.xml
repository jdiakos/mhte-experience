<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <changeSet id="1" author="dpappas">
        <sql>
            -- project definition

            CREATE TABLE project (
	            id bigint not null GENERATED BY DEFAULT AS IDENTITY,
	            adam varchar(255) NULL,
	            ape_value float8 NULL,
	            completion_date date NULL,
	            contracting_authority varchar(255) NULL,
	            date_of_signing date NULL,
	            description varchar(255) NULL,
	            estimated_completion_date date NULL,
	            head_authority varchar(255) NULL,
	            initial_contract_budget float8 NULL,
	            initial_contract_value float8 NULL,
	            project_category varchar(255) NULL,
	            protocol_number varchar(255) NULL,
	            receipt_protocol_date date NULL,
	            receipt_protocol_number varchar(255) NULL,
	            responsible_entity varchar(255) NULL,
	            supplementary_value float8 NULL,
	            title varchar(255) NULL,
	            total_value float8 NULL,
	            "type" varchar(255) NULL,
            CONSTRAINT project_pkey PRIMARY KEY (id)
            );

			-- DB2 does not support unique constraints on nullable columns, so this is the required workaround
			CREATE UNIQUE INDEX uk_csriijpxqvmdj1q6qghpyxk4o ON project(adam) exclude null keys;
			CREATE UNIQUE INDEX uk_ksidbafx63f60usihmncgswb4 ON project(protocol_number) exclude null keys;


			-- contract definition

            CREATE TABLE contract (
	            id bigint not null GENERATED BY DEFAULT AS IDENTITY,
	            contract_guid varchar(255) NULL,
	            contract_type varchar(255) NULL,
	            contract_value float8 NULL,
	            signing_date date NULL,
	            project_id int8 NULL,
				created_date timestamp NOT NULL,
				last_modification_date timestamp NOT NULL,
				last_modified_by varchar(255) NOT NULL,
            CONSTRAINT contract_pkey PRIMARY KEY (id),
            CONSTRAINT fkiuhnxiug4xixtcq9h6gtycxxh FOREIGN KEY (project_id) REFERENCES project(id) ON DELETE CASCADE
            );


            -- project_contractor definition

            CREATE TABLE project_contractor (
	            id bigint not null GENERATED BY DEFAULT AS IDENTITY,
	            contractor_id int8 NULL,
	            participation_percentage float8 NULL,
	            participation_type varchar(255) NULL,
	            project_id int8 NOT NULL,
	            created_date timestamp NOT NULL,
	            last_modification_date timestamp NOT NULL,
	            last_modified_by varchar(255) NOT NULL,
            CONSTRAINT project_contractor_pkey PRIMARY KEY (id),
            CONSTRAINT fkt7sg49sicadvfomubsi4f379r FOREIGN KEY (project_id) REFERENCES project(id) ON DELETE CASCADE
            );


            -- project_subcontractor definition

            CREATE TABLE project_subcontractor (
	            id bigint not null GENERATED BY DEFAULT AS IDENTITY,
	            contract_date_from date NULL,
	            contract_date_to date NULL,
	            contract_guid varchar(255) NULL,
	            contract_value float8 NULL,
	            participation_type varchar(255) NULL,
	            subcontractor_id int8 NULL,
	            project_id int8 NOT NULL,
				created_date timestamp NOT NULL,
				last_modification_date timestamp NOT NULL,
				last_modified_by varchar(255) NOT NULL,
			CONSTRAINT project_subcontractor_pkey PRIMARY KEY (id),
            CONSTRAINT fkq0twsi5ae14pu804t6imh14vj FOREIGN KEY (project_id) REFERENCES project(id) ON DELETE CASCADE
            );

            --revinfo table for audit purposes
            
            CREATE TABLE IF NOT EXISTS revinfo(
			    rev integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
			    revtstmp bigint,
			    CONSTRAINT revinfo_pkey PRIMARY KEY (rev)
			);

			-- project contractor audit table definition
			
			CREATE TABLE project_contractor_aud (
				id bigint  NOT NULL,
				rev INTEGER NOT NULL,
				revtype SMALLINT,
				last_modification_date TIMESTAMP(6),
				last_modified_by VARCHAR(255),
				participation_percentage DOUBLE PRECISION,
				participation_type VARCHAR(255),
				PRIMARY KEY (rev, id),
				CONSTRAINT fk7jfmu2u12wt681wmy1p2hwod3 FOREIGN KEY(rev) REFERENCES revinfo(rev)
			);

			-- project subcontractor audit table definition
			
			CREATE TABLE project_subcontractor_aud (
				id bigint  NOT NULL,
				rev INTEGER NOT NULL,
				revtype SMALLINT,
				contract_date_from DATE,
				contract_date_to DATE,
				contract_value DOUBLE PRECISION,
				last_modification_date TIMESTAMP(6),
				last_modified_by VARCHAR(255),
				participation_type VARCHAR(255),
				PRIMARY KEY (rev, id),
				CONSTRAINT fksgtpwk9bo6mkmm9pmps1u7uhh FOREIGN KEY(rev) REFERENCES revinfo(rev)
			);

			-- contract audit table definition
			CREATE TABLE contract_aud (
			    id bigint NOT NULL,
			    rev INTEGER NOT NULL,
			    revtype SMALLINT,
			    contract_guid VARCHAR(255),
				last_modification_date TIMESTAMP(6),
				last_modified_by VARCHAR(255),
				PRIMARY KEY (rev, id),
				CONSTRAINT fkdwmknd8t7wjk072bg4ka0gtnb FOREIGN KEY (rev) REFERENCES revinfo(rev)
			)


		</sql>
    </changeSet>
    
    
    <changeSet id="2" author="initialmzafeir">
        <sql>

            -- Project
            INSERT INTO project (adam, contracting_authority, description, head_authority, project_category, protocol_number, 
            	receipt_protocol_number, responsible_entity, title, "type",
            	ape_value, initial_contract_budget, initial_contract_value, supplementary_value, total_value, 
            	completion_date, date_of_signing, estimated_completion_date, receipt_protocol_date) 
            	VALUES
            	('20155785','Some contracting 1','some description 1', 'some head autority 1',
            	'PUBLIC_PROJECT', 'some protocol number 1', 'some receipt protocol 1', 'some responsible 1',
            	'title 1', 'type 1', 1111.11, 1111.11, 1111.11, 1111.11, 1111.11,
            	'01-01-2023', '01-01-2023', '01-01-2023', '01-01-2023');
            INSERT INTO project (adam, contracting_authority, description, head_authority, project_category, protocol_number, 
            	receipt_protocol_number, responsible_entity, title, "type",
            	ape_value, initial_contract_budget, initial_contract_value, supplementary_value, total_value, 
            	completion_date, date_of_signing, estimated_completion_date, receipt_protocol_date) 
            	VALUES
            	('46354345','Some contracting 2','some description 2', 'some head autority 2',
            	'PUBLIC_PROJECT', 'some protocol number 2', 'some receipt protocol 2', 'some responsible 2',
            	'title 2', 'type 2', 2222.22, 2222.22, 2222.22, 2222.22, 2222.22,
            	'02-02-2023', '02-02-2023', '02-02-2023', '02-02-2023');
            INSERT INTO project (adam, contracting_authority, description, head_authority, project_category, protocol_number, 
            	receipt_protocol_number, responsible_entity, title, "type",
            	ape_value, initial_contract_budget, initial_contract_value, supplementary_value, total_value, 
            	completion_date, date_of_signing, estimated_completion_date, receipt_protocol_date) 
            	VALUES
            	('324325435','Some contracting 3','some description 3', 'some head autority 3',
            	'PUBLIC_PROJECT', 'some protocol number 3', 'some receipt protocol 3', 'some responsible 3',
            	'title 3', 'type 3', 3333.33, 3333.33, 3333.33, 3333.33, 3333.33,
            	'03-03-2023', '03-03-2023', '03-03-2023', '03-03-2023');
            INSERT INTO project (adam, contracting_authority, description, head_authority, project_category, protocol_number, 
            	receipt_protocol_number, responsible_entity, title, "type",
            	ape_value, initial_contract_budget, initial_contract_value, supplementary_value, total_value, 
            	completion_date, date_of_signing, estimated_completion_date, receipt_protocol_date) 
            	VALUES
            	('46767656757','Some contracting 4','some description 4', 'some head autority 4',
            	'PUBLIC_PROJECT', 'some protocol number 4', 'some receipt protocol 4', 'some responsible 4',
            	'title 4', 'type 4', 4444.44, 4444.44, 4444.44, 4444.44, 4444.44,
            	'04-04-2023', '04-04-2023', '04-04-2023', '04-04-2023');


        </sql>
    </changeSet>


</databaseChangeLog>